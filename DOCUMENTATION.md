# documentation_for_iot_project

Запуск сервера и загрузка скетча в ESP:

1) Приобрести сервер со статическим IP адресом

2) Изменить IP адрес сервера в файле скетча

3) Запустить сервер (находясь в папке сервера в консоли cmd командой uvicorn main:app --port 8005 --reload --host 0.0.0.0) (возможно нужно добавить перед командой, что-то вроде python3 -m)

4) Загрузить скетч в ESP (без схемы), нажать reset и отключить от питания

5) Подключить ESP к схеме устройства

Инструкция по эксплуатации устройства:

1) Подключиться к точке доступа ESP и перейти в браузере на веб-форму по ip 192.168.99.34

2) Ввести логин и пароль сети wifi с доступом в интернет и нажать кнопку send (в веб-форме)

3) ESP подключается к wifi и переходит в режим ожидания

4) Нажать кнопку один раз

Быстрое нажатие кнопки переключает жёлто-зелёное и зелёное состояние устройства. Зажатие кнопки 3 секунды сбрасывает состояние до красного.

Состояния устройства:

красный - раздаёт точку доступа

синий - подключение к сети wifi

жёлто-зелёный (мигает) - связь wifi установлена, ожидание

зелёный - отправка данных на сервер

Описание проекта:

Устройство выдаётся пользователю вместе с именем устройства, паролем и ip веб-формы. Имя и пароль устройства, являются авторизационными данными для точки доступа esp и аккаунта esp на сайте с анализом отправленных данных на сервер. Сервер работает на python FastApi. Он принимает и сохраняет данные со всех устройств в базе данных, а также поднимает сайт с анализом полученных данных.

API запросы:

GET("/") - основная страница сервера

GET("/pm25/{esp_name}") - массив всех измерений pm2.5 по имени esp
    
    esp_name: str
    
GET("/pm10/{esp_name}") - массив всех измерений pm10 по имени esp

    esp_name: str
    
GET("/esp_names", response_model=list[str]) - массив всех имён esp

GET("/sensor") - 

POST("/sensor") - 

    interval: str = Form(...)
    
POST("/submit_air") - отправка данных на сервер

    pm25: int,
    
    pm10: int,
    
    esp_name: str
    
POST("/login") - авторизация пользователя

    esp_name: str = Form(...),
    
    password: str = Form(...)
    
POST("/change_password") - устаревший, неверный запрос

    esp_name: str = Form(...),
    
    password: str = Form(...),
    
    confirm_password: str = Form(...)

База данных (содержит две таблицы):

Data - таблица для хранения данных с датчиков

    id = Column(Integer, primary_key=True, index=True)
    
    pm25 = Column(Integer, nullable=False)
    
    pm10 = Column(Integer, nullable=False)
    
    esp_name = Column(String, nullable=False)
    
    timestamp = Column(DateTime, nullable=False)
    
Clients - таблица для хранения имён и паролей esp (они же аккаунты пользователей)

    id = Column(Integer, primary_key=True, index=True)
    
    esp_name = Column(String, unique=True, nullable=False)
    
    password = Column(String, nullable=False)
    

Сайт (содержит две страницы):

1. Основная страница - страница, для авторизации пользователя и перенаправления его в личный кабинет.

2. Личный кабинет - страница с анализом данных с конкретного устройства (график pm2.5 и pm10 с отображением границ загрязнения воздуха и вывод среднего результата за всё время).

Зайти в личный кабинет без авторизации нельзя. При авторизации данные сохраняются в cookie. Данные для авторизации имя esp и пароль.

Схема устройства

1. Датчик мелкодисперсных частиц, подключен к питанию и земле, данные считываются с двух пинов (RX, TX) по 10 байт в буфер и преобразовываются в два числа.

2. Кнопка, подключена к земле и INPUT_PULLUP пину, считывающему изменение HIGH / LOW.

3. Светодиод, подключен к питанию (прошедшему, через резистор) и трём пинам, на которые подаётся HIGH / LOW регулируя освещение.
